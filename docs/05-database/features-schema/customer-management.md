# üë• SCHEMA QU·∫¢N L√ù KH√ÅCH H√ÄNG - NextFlow CRM-AI

## üéØ T·ªîNG QUAN

**Schema Kh√°ch h√†ng** ƒë·ªãnh nghƒ©a c√°ch NextFlow CRM-AI l∆∞u tr·ªØ v√† qu·∫£n l√Ω th√¥ng tin kh√°ch h√†ng. ƒê√¢y l√† **tr√°i tim c·ªßa h·ªá th·ªëng CRM**, ch·ª©a t·∫•t c·∫£ d·ªØ li·ªáu v·ªÅ kh√°ch h√†ng t·ª´ th√¥ng tin c∆° b·∫£n ƒë·∫øn h√†nh vi mua s·∫Øm.

### üí° **Kh√°i ni·ªám c∆° b·∫£n:**
- **Customer (Kh√°ch h√†ng):** C√° nh√¢n ho·∫∑c doanh nghi·ªáp mua s·∫£n ph·∫©m/d·ªãch v·ª•
- **Contact (Li√™n h·ªá):** Th√¥ng tin li√™n l·∫°c (email, phone, address)
- **Segment (Ph√¢n kh√∫c):** Nh√≥m kh√°ch h√†ng c√≥ ƒë·∫∑c ƒëi·ªÉm t∆∞∆°ng t·ª±
- **Profile (H·ªì s∆°):** T·∫≠p h·ª£p th√¥ng tin chi ti·∫øt v·ªÅ kh√°ch h√†ng

### üîó **M·ªëi quan h·ªá d·ªØ li·ªáu:**
```
Kh√°ch h√†ng (Customers) ‚Üí Li√™n h·ªá (Contacts) ‚Üí ƒê·ªãa ch·ªâ (Addresses)
    ‚Üì                        ‚Üì                    ‚Üì
Ph√¢n kh√∫c (Segments) ‚Üí Ho·∫°t ƒë·ªông (Activities) ‚Üí Ph√¢n t√≠ch (Analytics)
```

---

## üè¢ C·∫§U TR√öC B·∫¢NG CH√çNH

### üë§ **1. B·∫¢NG CUSTOMERS (KH√ÅCH H√ÄNG)**

**M·ª•c ƒë√≠ch:** L∆∞u th√¥ng tin c∆° b·∫£n v·ªÅ kh√°ch h√†ng

#### **C√°c tr∆∞·ªùng d·ªØ li·ªáu quan tr·ªçng:**

```sql
-- B·∫£ng kh√°ch h√†ng ch√≠nh
CREATE TABLE customers (
    -- M√£ ƒë·ªãnh danh duy nh·∫•t (UUID: Universal Unique Identifier)
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- M√£ kh√°ch h√†ng (d·ªÖ nh·ªõ, v√≠ d·ª•: KH001, KH002)
    customer_code VARCHAR(50) UNIQUE NOT NULL,
    
    -- === TH√îNG TIN C∆† B·∫¢N ===
    -- Lo·∫°i kh√°ch h√†ng: c√° nh√¢n ho·∫∑c doanh nghi·ªáp
    type customer_type_enum DEFAULT 'individual',
    
    -- T√™n hi·ªÉn th·ªã ch√≠nh
    name VARCHAR(255) NOT NULL,
    display_name VARCHAR(255),
    
    -- === TH√îNG TIN DOANH NGHI·ªÜP ===
    -- T√™n c√¥ng ty (n·∫øu l√† kh√°ch h√†ng doanh nghi·ªáp)
    company_name VARCHAR(255),
    
    -- M√£ s·ªë thu·∫ø (MST)
    tax_number VARCHAR(50),
    
    -- Ng√†nh ngh·ªÅ kinh doanh
    industry VARCHAR(100),
    
    -- Quy m√¥ c√¥ng ty (nh·ªè, v·ª´a, l·ªõn)
    company_size company_size_enum,
    
    -- Doanh thu h√†ng nƒÉm (ƒë·ªÉ ƒë√°nh gi√° ti·ªÅm nƒÉng)
    annual_revenue DECIMAL(15,2),
    
    -- === TH√îNG TIN C√Å NH√ÇN ===
    first_name VARCHAR(100),    -- T√™n
    last_name VARCHAR(100),     -- H·ªç
    date_of_birth DATE,         -- Ng√†y sinh
    gender gender_enum,         -- Gi·ªõi t√≠nh
    
    -- === TH√îNG TIN LI√äN H·ªÜ ===
    primary_email VARCHAR(255),     -- Email ch√≠nh
    primary_phone VARCHAR(20),      -- S·ªë ƒëi·ªán tho·∫°i ch√≠nh
    website VARCHAR(255),           -- Website (cho doanh nghi·ªáp)
    
    -- === TH√îNG TIN KINH DOANH ===
    -- Tr·∫°ng th√°i kh√°ch h√†ng (m·ªõi, ƒëang ho·∫°t ƒë·ªông, ng·ª´ng ho·∫°t ƒë·ªông)
    status customer_status_enum DEFAULT 'active',
    
    -- Ngu·ªìn kh√°ch h√†ng (website, qu·∫£ng c√°o, gi·ªõi thi·ªáu)
    source VARCHAR(100),
    
    -- Nh√¢n vi√™n ph·ª• tr√°ch
    assigned_user_id UUID REFERENCES users(id),
    
    -- Gi√° tr·ªã kh√°ch h√†ng su·ªët ƒë·ªùi (Customer Lifetime Value)
    lifetime_value DECIMAL(15,2) DEFAULT 0,
    
    -- T·ªïng s·ªë ƒë∆°n h√†ng ƒë√£ mua
    total_orders INTEGER DEFAULT 0,
    
    -- T·ªïng gi√° tr·ªã ƒë√£ mua
    total_spent DECIMAL(15,2) DEFAULT 0,
    
    -- L·∫ßn mua cu·ªëi c√πng
    last_purchase_date TIMESTAMP,
    
    -- === METADATA ===
    -- Th√¥ng tin t·ªï ch·ª©c (multi-tenant)
    organization_id UUID NOT NULL REFERENCES organizations(id),
    
    -- Th·ªùi gian t·∫°o v√† c·∫≠p nh·∫≠t
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by UUID REFERENCES users(id),
    updated_by UUID REFERENCES users(id),
    
    -- Soft delete (x√≥a m·ªÅm - kh√¥ng x√≥a th·∫≠t kh·ªèi database)
    deleted_at TIMESTAMP,
    deleted_by UUID REFERENCES users(id)
);
```

#### **Gi·∫£i th√≠ch c√°c enum types:**

```sql
-- Lo·∫°i kh√°ch h√†ng
CREATE TYPE customer_type_enum AS ENUM (
    'individual',    -- C√° nh√¢n
    'business'       -- Doanh nghi·ªáp
);

-- Quy m√¥ c√¥ng ty
CREATE TYPE company_size_enum AS ENUM (
    'micro',         -- Vi m√¥ (1-10 nh√¢n vi√™n)
    'small',         -- Nh·ªè (11-50 nh√¢n vi√™n)
    'medium',        -- V·ª´a (51-250 nh√¢n vi√™n)
    'large',         -- L·ªõn (251-1000 nh√¢n vi√™n)
    'enterprise'     -- T·∫≠p ƒëo√†n (>1000 nh√¢n vi√™n)
);

-- Tr·∫°ng th√°i kh√°ch h√†ng
CREATE TYPE customer_status_enum AS ENUM (
    'prospect',      -- Ti·ªÅm nƒÉng (ch∆∞a mua)
    'active',        -- ƒêang ho·∫°t ƒë·ªông
    'inactive',      -- Ng·ª´ng ho·∫°t ƒë·ªông
    'churned',       -- ƒê√£ r·ªùi b·ªè
    'blocked'        -- B·ªã ch·∫∑n
);

-- Gi·ªõi t√≠nh
CREATE TYPE gender_enum AS ENUM (
    'male',          -- Nam
    'female',        -- N·ªØ
    'other',         -- Kh√°c
    'prefer_not_to_say' -- Kh√¥ng mu·ªën ti·∫øt l·ªô
);
```

### üìû **2. B·∫¢NG CUSTOMER_CONTACTS (LI√äN H·ªÜ KH√ÅCH H√ÄNG)**

**M·ª•c ƒë√≠ch:** L∆∞u nhi·ªÅu th√¥ng tin li√™n h·ªá cho m·ªôt kh√°ch h√†ng

```sql
CREATE TABLE customer_contacts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Li√™n k·∫øt v·ªõi kh√°ch h√†ng
    customer_id UUID NOT NULL REFERENCES customers(id) ON DELETE CASCADE,
    
    -- Lo·∫°i li√™n h·ªá (email, phone, social media)
    contact_type contact_type_enum NOT NULL,
    
    -- Gi√° tr·ªã li√™n h·ªá
    contact_value VARCHAR(255) NOT NULL,
    
    -- Nh√£n m√¥ t·∫£ (c√¥ng vi·ªác, c√° nh√¢n, kh·∫©n c·∫•p)
    label VARCHAR(100),
    
    -- C√≥ ph·∫£i li√™n h·ªá ch√≠nh kh√¥ng
    is_primary BOOLEAN DEFAULT FALSE,
    
    -- ƒê√£ x√°c minh ch∆∞a (email verified, phone verified)
    is_verified BOOLEAN DEFAULT FALSE,
    
    -- Th·ªùi gian x√°c minh
    verified_at TIMESTAMP,
    
    -- Metadata
    organization_id UUID NOT NULL REFERENCES organizations(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Lo·∫°i li√™n h·ªá
CREATE TYPE contact_type_enum AS ENUM (
    'email',         -- Email
    'phone',         -- ƒêi·ªán tho·∫°i
    'mobile',        -- Di ƒë·ªông
    'fax',           -- Fax
    'website',       -- Website
    'facebook',      -- Facebook
    'zalo',          -- Zalo
    'telegram',      -- Telegram
    'linkedin',      -- LinkedIn
    'other'          -- Kh√°c
);
```

### üè† **3. B·∫¢NG CUSTOMER_ADDRESSES (ƒê·ªäA CH·ªà KH√ÅCH H√ÄNG)**

**M·ª•c ƒë√≠ch:** L∆∞u ƒë·ªãa ch·ªâ giao h√†ng, thanh to√°n c·ªßa kh√°ch h√†ng

```sql
CREATE TABLE customer_addresses (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Li√™n k·∫øt v·ªõi kh√°ch h√†ng
    customer_id UUID NOT NULL REFERENCES customers(id) ON DELETE CASCADE,
    
    -- Lo·∫°i ƒë·ªãa ch·ªâ
    address_type address_type_enum NOT NULL,
    
    -- Th√¥ng tin ƒë·ªãa ch·ªâ chi ti·∫øt
    address_line_1 VARCHAR(255) NOT NULL,  -- S·ªë nh√†, t√™n ƒë∆∞·ªùng
    address_line_2 VARCHAR(255),           -- Ph∆∞·ªùng, qu·∫≠n (optional)
    
    -- ƒê∆°n v·ªã h√†nh ch√≠nh Vi·ªát Nam
    ward VARCHAR(100),          -- Ph∆∞·ªùng/X√£
    district VARCHAR(100),      -- Qu·∫≠n/Huy·ªán
    city VARCHAR(100),          -- T·ªânh/Th√†nh ph·ªë
    country VARCHAR(100) DEFAULT 'Vietnam', -- Qu·ªëc gia
    postal_code VARCHAR(20),    -- M√£ b∆∞u ƒëi·ªán
    
    -- T·ªça ƒë·ªô GPS (ƒë·ªÉ t√≠nh kho·∫£ng c√°ch giao h√†ng)
    latitude DECIMAL(10, 8),
    longitude DECIMAL(11, 8),
    
    -- C√≥ ph·∫£i ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh kh√¥ng
    is_default BOOLEAN DEFAULT FALSE,
    
    -- Ghi ch√∫ th√™m (c√°ch t√¨m ƒë∆∞·ªùng, landmark)
    notes TEXT,
    
    -- Metadata
    organization_id UUID NOT NULL REFERENCES organizations(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Lo·∫°i ƒë·ªãa ch·ªâ
CREATE TYPE address_type_enum AS ENUM (
    'billing',       -- ƒê·ªãa ch·ªâ thanh to√°n
    'shipping',      -- ƒê·ªãa ch·ªâ giao h√†ng
    'office',        -- ƒê·ªãa ch·ªâ vƒÉn ph√≤ng
    'home',          -- ƒê·ªãa ch·ªâ nh√† ri√™ng
    'warehouse',     -- ƒê·ªãa ch·ªâ kho
    'other'          -- Kh√°c
);
```

### üéØ **4. B·∫¢NG CUSTOMER_SEGMENTS (PH√ÇN KH√öC KH√ÅCH H√ÄNG)**

**M·ª•c ƒë√≠ch:** Nh√≥m kh√°ch h√†ng theo ti√™u ch√≠ ƒë·ªÉ marketing hi·ªáu qu·∫£

```sql
CREATE TABLE customer_segments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- T√™n ph√¢n kh√∫c
    name VARCHAR(255) NOT NULL,
    
    -- M√¥ t·∫£ chi ti·∫øt
    description TEXT,
    
    -- M√†u s·∫Øc hi·ªÉn th·ªã tr√™n UI
    color VARCHAR(7), -- Hex color code (#FF0000)
    
    -- ƒêi·ªÅu ki·ªán ph√¢n kh√∫c (JSON format)
    criteria JSONB,
    
    -- Lo·∫°i ph√¢n kh√∫c (t·ª± ƒë·ªông ho·∫∑c th·ªß c√¥ng)
    segment_type segment_type_enum DEFAULT 'manual',
    
    -- C√≥ ho·∫°t ƒë·ªông kh√¥ng
    is_active BOOLEAN DEFAULT TRUE,
    
    -- S·ªë l∆∞·ª£ng kh√°ch h√†ng trong ph√¢n kh√∫c
    customer_count INTEGER DEFAULT 0,
    
    -- Metadata
    organization_id UUID NOT NULL REFERENCES organizations(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by UUID REFERENCES users(id)
);

-- Lo·∫°i ph√¢n kh√∫c
CREATE TYPE segment_type_enum AS ENUM (
    'manual',        -- Th·ªß c√¥ng (admin t·ª± ch·ªçn kh√°ch h√†ng)
    'automatic',     -- T·ª± ƒë·ªông (d·ª±a tr√™n ƒëi·ªÅu ki·ªán)
    'ai_generated'   -- AI t·∫°o t·ª± ƒë·ªông
);

-- B·∫£ng li√™n k·∫øt kh√°ch h√†ng v·ªõi ph√¢n kh√∫c (many-to-many)
CREATE TABLE customer_segment_members (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    customer_id UUID NOT NULL REFERENCES customers(id) ON DELETE CASCADE,
    segment_id UUID NOT NULL REFERENCES customer_segments(id) ON DELETE CASCADE,
    
    -- Th·ªùi gian th√™m v√†o ph√¢n kh√∫c
    added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    added_by UUID REFERENCES users(id),
    
    -- Unique constraint ƒë·ªÉ tr√°nh duplicate
    UNIQUE(customer_id, segment_id)
);
```

---

## üìä CH·ªà M·ª§C V√Ä T·ªêI ∆ØU HI·ªÜU SU·∫§T

### üöÄ **Indexes quan tr·ªçng:**

```sql
-- T√¨m ki·∫øm kh√°ch h√†ng theo t√™n (full-text search)
CREATE INDEX idx_customers_name_fulltext ON customers 
USING gin(to_tsvector('vietnamese', name || ' ' || COALESCE(company_name, '')));

-- T√¨m ki·∫øm theo email v√† phone
CREATE INDEX idx_customers_email ON customers(primary_email);
CREATE INDEX idx_customers_phone ON customers(primary_phone);

-- L·ªçc theo tr·∫°ng th√°i v√† ngu·ªìn
CREATE INDEX idx_customers_status_source ON customers(status, source);

-- S·∫Øp x·∫øp theo gi√° tr·ªã kh√°ch h√†ng
CREATE INDEX idx_customers_lifetime_value ON customers(lifetime_value DESC);

-- Multi-tenant index
CREATE INDEX idx_customers_org_id ON customers(organization_id);

-- Soft delete index
CREATE INDEX idx_customers_not_deleted ON customers(id) WHERE deleted_at IS NULL;
```

### ‚ö° **Performance Tips:**
- **Partition by organization_id:** Chia b·∫£ng theo t·ªï ch·ª©c ƒë·ªÉ tƒÉng t·ªëc
- **Archive old data:** Chuy·ªÉn kh√°ch h√†ng c≈© sang b·∫£ng archive
- **Use materialized views:** Cho c√°c b√°o c√°o ph·ª©c t·∫°p
- **Cache frequent queries:** D√πng Redis cache cho top customers

---

## üîí B·∫¢O M·∫¨T V√Ä QUY·ªÄN RI√äNG T∆Ø

### üõ°Ô∏è **Row Level Security (RLS):**

```sql
-- Ch·ªâ cho ph√©p xem kh√°ch h√†ng trong t·ªï ch·ª©c c·ªßa m√¨nh
ALTER TABLE customers ENABLE ROW LEVEL SECURITY;

CREATE POLICY customers_org_isolation ON customers
    FOR ALL TO authenticated_users
    USING (organization_id = current_setting('app.current_org_id')::UUID);
```

### üîê **Data Encryption:**
- **PII Fields:** M√£ h√≥a email, phone, address
- **Sensitive Data:** M√£ h√≥a tax_number, annual_revenue
- **At Rest:** Database encryption
- **In Transit:** SSL/TLS cho API calls

### üìù **Audit Trail:**
```sql
-- B·∫£ng audit log cho customers
CREATE TABLE customer_audit_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    customer_id UUID NOT NULL,
    action VARCHAR(50) NOT NULL, -- CREATE, UPDATE, DELETE
    old_values JSONB,
    new_values JSONB,
    changed_by UUID REFERENCES users(id),
    changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ip_address INET,
    user_agent TEXT
);
```

---

## üéØ USE CASES TH·ª∞C T·∫æ

### üìà **1. Customer Segmentation (Ph√¢n kh√∫c kh√°ch h√†ng)**
```sql
-- T√¨m kh√°ch h√†ng VIP (mua > 50 tri·ªáu trong nƒÉm)
SELECT c.*, 
       c.total_spent as "T·ªïng chi ti√™u",
       c.total_orders as "S·ªë ƒë∆°n h√†ng"
FROM customers c 
WHERE c.total_spent > 50000000 
  AND c.status = 'active'
  AND c.organization_id = :org_id
ORDER BY c.total_spent DESC;
```

### üéÇ **2. Birthday Marketing Campaign**
```sql
-- Kh√°ch h√†ng c√≥ sinh nh·∫≠t trong th√°ng n√†y
SELECT c.name, c.primary_email, c.date_of_birth
FROM customers c
WHERE EXTRACT(MONTH FROM c.date_of_birth) = EXTRACT(MONTH FROM CURRENT_DATE)
  AND c.status = 'active'
  AND c.primary_email IS NOT NULL;
```

### üìû **3. Customer Support Priority**
```sql
-- Kh√°ch h√†ng c·∫ßn ∆∞u ti√™n h·ªó tr·ª£ (VIP + c√≥ v·∫•n ƒë·ªÅ g·∫ßn ƒë√¢y)
SELECT c.name, c.lifetime_value, 
       COUNT(t.id) as "S·ªë ticket g·∫ßn ƒë√¢y"
FROM customers c
LEFT JOIN support_tickets t ON c.id = t.customer_id 
    AND t.created_at > CURRENT_DATE - INTERVAL '30 days'
WHERE c.lifetime_value > 10000000
GROUP BY c.id, c.name, c.lifetime_value
HAVING COUNT(t.id) > 0
ORDER BY c.lifetime_value DESC;
```

---

## üìû H·ªñ TR·ª¢ V√Ä T√ÄI LI·ªÜU

### üÜò **C·∫ßn h·ªó tr·ª£ v·ªÅ Customer Schema?**
- **üìß Email:** customer-schema@nextflow-crm.com
- **üìû Hotline:** 1900-xxx-xxx (ext. 7)
- **üí¨ Live Chat:** Trong ·ª©ng d·ª•ng NextFlow CRM-AI

### üìö **T√†i li·ªáu li√™n quan:**
- **üìä [Schema Analytics](./bao-cao-phan-tich.md.md)** - B√°o c√°o kh√°ch h√†ng
- **üõí [Schema ƒê∆°n h√†ng](./don-hang.md.md)** - Li√™n k·∫øt v·ªõi orders
- **üì¢ [Schema Marketing](./marketing.md.md)** - Campaigns cho customers
- **üîó [M·ªëi quan h·ªá Schema](../moi-quan-he-schema%20(M·ªëi%20quan%20h·ªá%20gi·ªØa%20c√°c%20schema).md)**

---

**C·∫≠p nh·∫≠t:** [Ng√†y th√°ng nƒÉm] | **Version:** 1.0.0 | **NextFlow Database Team**