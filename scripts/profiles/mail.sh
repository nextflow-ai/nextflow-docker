#!/bin/bash

# ============================================================================
# NEXTFLOW MAIL SERVER DEPLOYMENT SCRIPT
# ============================================================================
# M√¥ t·∫£: Script tri·ªÉn khai Stalwart Mail Server v·ªõi ƒë·∫ßy ƒë·ªß t√≠nh nƒÉng
# T√°c gi·∫£: NextFlow Team
# Phi√™n b·∫£n: 1.0
# C·∫≠p nh·∫≠t: 2025
# ============================================================================

# X·ª≠ l√Ω l·ªói nghi√™m ng·∫∑t
set -euo pipefail

# ƒê·ªãnh nghƒ©a th∆∞ m·ª•c
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
SCRIPTS_DIR="$PROJECT_ROOT/scripts"

# Import c√°c script ti·ªán √≠ch
source "$SCRIPTS_DIR/utils/logging.sh"
source "$SCRIPTS_DIR/utils/docker.sh"
source "$SCRIPTS_DIR/utils/validation.sh"

# ============================================================================
# C·∫§U H√åNH MAIL SERVER
# ============================================================================

# Danh s√°ch services cho mail profile
MAIL_SERVICES=(
    "postgres"          # Database ch√≠nh
    "redis"             # Cache v√† session
    "stalwart-mail"     # Mail server ch√≠nh
)

# C·∫•u h√¨nh Cloudflare tunnel cho mail
MAIL_TUNNEL_CONFIG=(
    "mail:8080"         # Web admin interface
    "smtp:587"          # SMTP submission
    "imap:993"          # IMAPS
)

# Ports c·∫ßn thi·∫øt cho mail server
REQUIRED_PORTS=(
    25      # SMTP
    110     # POP3
    143     # IMAP
    465     # SMTPS
    587     # SMTP Submission
    993     # IMAPS
    995     # POP3S
    4190    # ManageSieve
    8080    # Web Admin
)

# ============================================================================
# FUNCTIONS
# ============================================================================

# Ki·ªÉm tra y√™u c·∫ßu h·ªá th·ªëng
check_mail_requirements() {
    log_info "Ki·ªÉm tra y√™u c·∫ßu h·ªá th·ªëng cho Mail Server..."

    # Ki·ªÉm tra Docker v√† Docker Compose
    check_docker
    check_docker_compose

    # Ki·ªÉm tra file c·∫•u h√¨nh
    validate_file_exists "$PROJECT_ROOT/docker-compose.yml"
    validate_file_exists "$PROJECT_ROOT/.env"

    # Ki·ªÉm tra c√∫ ph√°p docker-compose
    validate_docker_compose_file "$PROJECT_ROOT/docker-compose.yml"

    log_success "T·∫•t c·∫£ y√™u c·∫ßu h·ªá th·ªëng ƒë√£ ƒë∆∞·ª£c ƒë√°p ·ª©ng"
}

# Ki·ªÉm tra xung ƒë·ªôt port
check_port_conflicts() {
    log_info "Ki·ªÉm tra xung ƒë·ªôt port..."
    
    local conflicts_found=false
    
    for port in "${REQUIRED_PORTS[@]}"; do
        if netstat -tuln 2>/dev/null | grep -q ":$port "; then
            log_warning "Port $port ƒëang ƒë∆∞·ª£c s·ª≠ d·ª•ng"
            conflicts_found=true
        fi
    done
    
    if [ "$conflicts_found" = true ]; then
        log_warning "Ph√°t hi·ªán xung ƒë·ªôt port. Vui l√≤ng ki·ªÉm tra v√† d·ª´ng c√°c service ƒëang s·ª≠ d·ª•ng port n√†y."
        read -p "B·∫°n c√≥ mu·ªën ti·∫øp t·ª•c? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            log_error "H·ªßy b·ªè tri·ªÉn khai do xung ƒë·ªôt port"
            exit 1
        fi
    else
        log_success "Kh√¥ng c√≥ xung ƒë·ªôt port"
    fi
}

# T·∫°o th∆∞ m·ª•c c·∫ßn thi·∫øt
create_mail_directories() {
    log_info "T·∫°o th∆∞ m·ª•c c·∫ßn thi·∫øt cho Mail Server..."
    
    local directories=(
        "$PROJECT_ROOT/stalwart/config"
        "$PROJECT_ROOT/stalwart/certs"
        "$PROJECT_ROOT/stalwart/data"
        "$PROJECT_ROOT/stalwart/logs"
        "$PROJECT_ROOT/stalwart/backups"
    )
    
    for dir in "${directories[@]}"; do
        if [ ! -d "$dir" ]; then
            mkdir -p "$dir"
            log_info "ƒê√£ t·∫°o th∆∞ m·ª•c: $dir"
        fi
    done
    
    # T·∫°o file c·∫•u h√¨nh m·∫∑c ƒë·ªãnh n·∫øu ch∆∞a c√≥
    create_default_mail_config
    
    log_success "ƒê√£ t·∫°o t·∫•t c·∫£ th∆∞ m·ª•c c·∫ßn thi·∫øt"
}

# T·∫°o c·∫•u h√¨nh m·∫∑c ƒë·ªãnh
create_default_mail_config() {
    local config_file="$PROJECT_ROOT/stalwart/config/stalwart-mail.toml"

    # L·∫•y th√¥ng tin t·ª´ environment variables
    local mail_hostname="${MAIL_HOSTNAME:-mail.nextflow.vn}"
    local mail_db_name="${MAIL_DB_NAME:-nextflow_stalwart_mail}"
    local mail_db_user="${MAIL_DB_USER:-nextflow_stalwart}"
    local mail_db_password="${MAIL_DB_PASSWORD:-nextflow@2025}"
    local mail_admin_user="${MAIL_ADMIN_USER:-admin}"
    local mail_admin_password="${MAIL_ADMIN_PASSWORD:-nextflow@2025}"

    if [ ! -f "$config_file" ]; then
        log_info "T·∫°o file c·∫•u h√¨nh m·∫∑c ƒë·ªãnh v·ªõi th√¥ng tin t·ª´ .env..."

        cat > "$config_file" << EOF
# Stalwart Mail Server Configuration
# Generated by NextFlow deployment script
# C·∫•u h√¨nh ƒë∆∞·ª£c ƒë·ªìng b·ªô v·ªõi environment variables trong .env

[server]
hostname = "$mail_hostname"
bind = ["0.0.0.0:25", "0.0.0.0:587", "0.0.0.0:465"]

[server.tls]
certificate = "/etc/stalwart/certs/cert.pem"
private-key = "/etc/stalwart/certs/key.pem"

[storage]
type = "postgresql"
host = "postgres"
port = 5432
database = "$mail_db_name"
username = "$mail_db_user"
password = "$mail_db_password"

[authentication]
type = "sql"

# C·∫•u h√¨nh admin user m·∫∑c ƒë·ªãnh
[authentication.admin]
username = "$mail_admin_user"
password = "$mail_admin_password"

[smtp]
max-message-size = 52428800  # 50MB
max-recipients = 100
require-auth = true

[imap]
bind = ["0.0.0.0:143", "0.0.0.0:993"]

[pop3]
bind = ["0.0.0.0:110", "0.0.0.0:995"]

[sieve]
bind = ["0.0.0.0:4190"]

[web]
bind = ["0.0.0.0:80"]  # Port 80 trong container, map ra 8005 b√™n ngo√†i

[security]
dkim.enable = true
spf.enable = true
dmarc.enable = true

[anti-spam]
enable = true
threshold = 5.0

[logging]
level = "info"
format = "json"

# C·∫•u h√¨nh NextFlow specific
[nextflow]
domain = "$mail_hostname"
admin_email = "$mail_admin_user@$mail_hostname"
EOF

        log_success "ƒê√£ t·∫°o file c·∫•u h√¨nh m·∫∑c ƒë·ªãnh: $config_file"
    else
        log_info "File c·∫•u h√¨nh ƒë√£ t·ªìn t·∫°i: $config_file"
    fi
}

# Ki·ªÉm tra services c∆° b·∫£n
check_basic_services() {
    log_info "Ki·ªÉm tra tr·∫°ng th√°i services c∆° b·∫£n..."
    
    # Ki·ªÉm tra PostgreSQL
    if ! is_container_running "postgres"; then
        log_info "PostgreSQL ch∆∞a ch·∫°y, kh·ªüi ƒë·ªông services c∆° b·∫£n..."
        cd "$PROJECT_ROOT"
        docker-compose --profile basic up -d postgres redis
        
        # Ch·ªù services s·∫µn s√†ng
        wait_for_container_healthy "postgres" 60
        wait_for_container_healthy "redis" 30
    else
        log_success "Services c∆° b·∫£n ƒë√£ s·∫µn s√†ng"
    fi
}

# T·∫°o database cho mail server
setup_mail_database() {
    log_info "Thi·∫øt l·∫≠p database cho Mail Server..."

    # L·∫•y th√¥ng tin database t·ª´ environment variables
    local db_user="${POSTGRES_USER:-nextflow}"
    local db_password="${POSTGRES_PASSWORD:-nextflow@2025}"
    local mail_db_name="${MAIL_DB_NAME:-nextflow_stalwart_mail}"
    local mail_db_user="${MAIL_DB_USER:-nextflow_stalwart}"
    local mail_db_password="${MAIL_DB_PASSWORD:-nextflow@2025}"
    local old_db_name="stalwart_mail"

    # X√≥a database c≈© n·∫øu t·ªìn t·∫°i
    if docker exec postgres psql -U "$db_user" -lqt | cut -d \| -f 1 | grep -qw "$old_db_name"; then
        log_warning "Ph√°t hi·ªán database c≈©: $old_db_name"
        read -p "X√≥a database c≈© $old_db_name? (Y/n): " -r
        if [[ ! $REPLY =~ ^[Nn]$ ]]; then
            log_info "X√≥a database c≈© $old_db_name..."
            docker exec postgres psql -U "$db_user" -c "DROP DATABASE IF EXISTS $old_db_name;"
            log_success "ƒê√£ x√≥a database c≈©"
        fi
    fi

    # Ki·ªÉm tra v√† t·∫°o database m·ªõi
    if docker exec postgres psql -U "$db_user" -lqt | cut -d \| -f 1 | grep -qw "$mail_db_name"; then
        log_success "Database $mail_db_name ƒë√£ t·ªìn t·∫°i"
    else
        log_info "T·∫°o database v√† user m·ªõi cho Stalwart Mail Server..."

        # T·∫°o database
        docker exec postgres psql -U "$db_user" -c "CREATE DATABASE $mail_db_name;"

        # T·∫°o user n·∫øu ch∆∞a c√≥
        if ! docker exec postgres psql -U "$db_user" -c "\du" | grep -qw "$mail_db_user"; then
            docker exec postgres psql -U "$db_user" -c "CREATE USER $mail_db_user WITH PASSWORD '$mail_db_password';"
        fi

        # C·∫•p quy·ªÅn
        docker exec postgres psql -U "$db_user" -c "GRANT ALL PRIVILEGES ON DATABASE $mail_db_name TO $mail_db_user;"
        docker exec postgres psql -U "$db_user" -c "ALTER USER $mail_db_user CREATEDB;"
        docker exec postgres psql -U "$db_user" -c "ALTER DATABASE $mail_db_name OWNER TO $mail_db_user;"

        log_success "ƒê√£ t·∫°o database $mail_db_name v√† user $mail_db_user"
    fi

    # Ki·ªÉm tra k·∫øt n·ªëi database
    log_info "Ki·ªÉm tra k·∫øt n·ªëi database..."
    if docker exec postgres psql -U "$mail_db_user" -d "$mail_db_name" -c "SELECT 1;" &>/dev/null; then
        log_success "K·∫øt n·ªëi database th√†nh c√¥ng"
    else
        log_warning "Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi database b·∫±ng user $mail_db_user"
        log_info "Th·ª≠ c·∫•p quy·ªÅn l·∫°i..."
        docker exec postgres psql -U "$db_user" -c "GRANT ALL PRIVILEGES ON DATABASE $mail_db_name TO $mail_db_user;"
        docker exec postgres psql -U "$db_user" -c "ALTER DATABASE $mail_db_name OWNER TO $mail_db_user;"
    fi

    # T·∫°o schema c∆° b·∫£n cho Stalwart Mail
    log_info "T·∫°o schema c∆° b·∫£n cho Stalwart Mail..."
    local mail_hostname="${MAIL_HOSTNAME:-mail.nextflow.vn}"
    local mail_admin_user="${MAIL_ADMIN_USER:-admin}"
    local mail_admin_password="${MAIL_ADMIN_PASSWORD:-nextflow@2025}"

    docker exec postgres psql -U "$mail_db_user" -d "$mail_db_name" -c "
        -- T·∫°o b·∫£ng users
        CREATE TABLE IF NOT EXISTS users (
            id SERIAL PRIMARY KEY,
            username VARCHAR(255) UNIQUE NOT NULL,
            email VARCHAR(255) UNIQUE NOT NULL,
            password_hash VARCHAR(255) NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            active BOOLEAN DEFAULT TRUE
        );

        -- T·∫°o b·∫£ng domains
        CREATE TABLE IF NOT EXISTS domains (
            id SERIAL PRIMARY KEY,
            domain VARCHAR(255) UNIQUE NOT NULL,
            active BOOLEAN DEFAULT TRUE,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );

        -- T·∫°o b·∫£ng aliases
        CREATE TABLE IF NOT EXISTS aliases (
            id SERIAL PRIMARY KEY,
            source VARCHAR(255) NOT NULL,
            destination VARCHAR(255) NOT NULL,
            domain_id INTEGER REFERENCES domains(id),
            active BOOLEAN DEFAULT TRUE,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );

        -- T·∫°o admin user m·∫∑c ƒë·ªãnh v·ªõi password hash
        INSERT INTO users (username, email, password_hash)
        VALUES ('$mail_admin_user', '$mail_admin_user@$mail_hostname', '\$2b\$12\$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewdBPj/A5/jF/.OC')
        ON CONFLICT (username) DO NOTHING;

        -- T·∫°o domain m·∫∑c ƒë·ªãnh
        INSERT INTO domains (domain)
        VALUES ('$mail_hostname')
        ON CONFLICT (domain) DO NOTHING;
    " 2>/dev/null || log_warning "Kh√¥ng th·ªÉ t·∫°o schema (c√≥ th·ªÉ do extension ch∆∞a c√≥)"

    log_success "Ho√†n th√†nh thi·∫øt l·∫≠p database"
}

# Tri·ªÉn khai Stalwart Mail Server qua docker-compose (Chu·∫©n h√≥a)
deploy_mail_via_compose() {
    local force_deploy="${1:-false}"

    log_info "Tri·ªÉn khai Stalwart Mail Server qua docker-compose..."

    cd "$PROJECT_ROOT"

    # D·ª´ng container c≈© n·∫øu force deploy
    if [[ "$force_deploy" == "true" ]]; then
        log_info "Force deploy: D·ª´ng containers c≈©..."
        docker-compose --profile mail down --remove-orphans 2>/dev/null || true
    fi

    # Ki·ªÉm tra v√† d·ª´ng container hi·ªán t·∫°i n·∫øu c·∫ßn
    if docker ps | grep -q "stalwart-mail"; then
        log_info "D·ª´ng container stalwart-mail hi·ªán t·∫°i..."
        docker-compose down stalwart-mail 2>/dev/null || true
    fi

    # Deploy v·ªõi profile mail
    log_info "Kh·ªüi ƒë·ªông profile mail..."
    if docker-compose --profile mail up -d; then
        log_success "‚úÖ ƒê√£ kh·ªüi ƒë·ªông Mail Server qua docker-compose"
    else
        log_error "‚ùå L·ªói khi kh·ªüi ƒë·ªông Mail Server"
        return 1
    fi
}

# Tri·ªÉn khai Mail Server (Legacy method - deprecated)
deploy_mail_server() {
    log_warning "‚ö†Ô∏è deploy_mail_server() deprecated, s·ª≠ d·ª•ng deploy_mail_via_compose()"
    deploy_mail_via_compose "$@"
}

# Function ch·ªù container healthy (Import t·ª´ utils)
wait_for_container_healthy() {
    local container_name="$1"
    local timeout="${2:-120}"
    local attempt=1
    local max_attempts=$((timeout / 5))

    log_info "Ch·ªù container '$container_name' healthy (timeout: ${timeout}s)..."

    while [ $attempt -le $max_attempts ]; do
        if docker ps | grep -q "$container_name"; then
            local health_status=$(docker inspect --format='{{.State.Health.Status}}' "$container_name" 2>/dev/null || echo "unknown")

            if [[ "$health_status" == "healthy" ]]; then
                log_success "Container '$container_name' ƒë√£ healthy"
                return 0
            elif [[ "$health_status" == "unhealthy" ]]; then
                log_warning "Container '$container_name' unhealthy, ti·∫øp t·ª•c ch·ªù..."
            else
                log_info "Container '$container_name' health status: $health_status"
            fi
        else
            log_warning "Container '$container_name' kh√¥ng ch·∫°y"
        fi

        sleep 5
        ((attempt++))
    done

    log_warning "Container '$container_name' kh√¥ng healthy sau ${timeout}s"
    return 1
}

# Ch·ªù Mail Server s·∫µn s√†ng
wait_for_mail_ready() {
    log_info "Ch·ªù Mail Server s·∫µn s√†ng..."

    local mail_admin_port="${MAIL_ADMIN_PORT:-8005}"

    # Ch·ªù container healthy
    if wait_for_container_healthy "stalwart-mail" 120; then
        log_success "Container stalwart-mail ƒë√£ healthy"
    else
        log_warning "Container ch∆∞a healthy, ti·∫øp t·ª•c ki·ªÉm tra port..."
    fi

    # Ki·ªÉm tra c√°c port quan tr·ªçng
    local max_attempts=30
    local attempt=1
    local ports_to_check=("$mail_admin_port" "25" "587")

    while [ $attempt -le $max_attempts ]; do
        local all_ports_ready=true

        for port in "${ports_to_check[@]}"; do
            if ! nc -z localhost "$port" 2>/dev/null; then
                all_ports_ready=false
                break
            fi
        done

        if [ "$all_ports_ready" = true ]; then
            log_success "Mail Server ƒë√£ s·∫µn s√†ng! T·∫•t c·∫£ ports ƒë√£ m·ªü."
            return 0
        fi

        log_info "Ch·ªù Mail Server kh·ªüi ƒë·ªông... (l·∫ßn th·ª≠ $attempt/$max_attempts)"
        log_info "Ki·ªÉm tra ports: ${ports_to_check[*]}"
        sleep 5
        ((attempt++))
    done

    log_error "Mail Server kh√¥ng th·ªÉ kh·ªüi ƒë·ªông sau $max_attempts l·∫ßn th·ª≠"
    log_info "Ki·ªÉm tra logs: docker logs stalwart-mail"
    return 1
}

# Hi·ªÉn th·ªã th√¥ng tin truy c·∫≠p
show_mail_access_info() {
    # L·∫•y th√¥ng tin t·ª´ environment variables
    local mail_hostname="${MAIL_HOSTNAME:-mail.nextflow.vn}"
    local mail_admin_user="${MAIL_ADMIN_USER:-admin}"
    local mail_admin_password="${MAIL_ADMIN_PASSWORD:-nextflow@2025}"
    local mail_admin_port="${MAIL_ADMIN_PORT:-8005}"

    log_info "=== TH√îNG TIN TRUY C·∫¨P STALWART MAIL SERVER ==="
    echo
    log_info "üåê Web Admin Interface:"
    echo "   URL: http://localhost:$mail_admin_port"
    echo "   Hostname: $mail_hostname"
    echo "   Username: $mail_admin_user"
    echo "   Password: $mail_admin_password"
    echo
    log_info "üìß SMTP Configuration:"
    echo "   Server: localhost ho·∫∑c $mail_hostname"
    echo "   Port 25: SMTP (kh√¥ng m√£ h√≥a)"
    echo "   Port 587: SMTP Submission (STARTTLS)"
    echo "   Port 465: SMTP Submissions (SSL/TLS)"
    echo "   Authentication: Required"
    echo
    log_info "üì¨ IMAP Configuration:"
    echo "   Server: localhost ho·∫∑c $mail_hostname"
    echo "   Port 143: IMAP (STARTTLS)"
    echo "   Port 993: IMAPS (SSL/TLS)"
    echo
    log_info "üìÆ POP3 Configuration:"
    echo "   Server: localhost ho·∫∑c $mail_hostname"
    echo "   Port 110: POP3 (STARTTLS)"
    echo "   Port 995: POP3S (SSL/TLS)"
    echo
    log_info "üîß ManageSieve:"
    echo "   Server: localhost ho·∫∑c $mail_hostname"
    echo "   Port: 4190"
    echo
    log_info "üóÑÔ∏è Database:"
    echo "   Type: PostgreSQL (shared)"
    echo "   Database: ${MAIL_DB_NAME:-stalwart_mail}"
    echo "   User: ${MAIL_DB_USER:-stalwart}"
    echo
    log_warning "‚ö†Ô∏è  L∆ØU √ù QUAN TR·ªåNG:"
    echo "   - M·∫≠t kh·∫©u admin: $mail_admin_password"
    echo "   - Thay ƒë·ªïi m·∫≠t kh·∫©u trong m√¥i tr∆∞·ªùng production"
    echo "   - C·∫•u h√¨nh SSL certificates cho production"
    echo "   - Thi·∫øt l·∫≠p DNS records (MX, SPF, DKIM, DMARC)"
    echo "   - C·∫•u h√¨nh firewall cho c√°c port mail"
    echo "   - S·ª≠ d·ª•ng PostgreSQL shared v·ªõi c√°c service kh√°c"
    echo
    log_info "üìã KI·ªÇM TRA TR·∫†NG TH√ÅI:"
    echo "   docker ps | grep stalwart-mail"
    echo "   docker logs stalwart-mail"
    echo "   curl -I http://localhost:$mail_admin_port"
    echo
}

# Tri·ªÉn khai Cloudflare tunnel cho mail
deploy_mail_tunnel() {
    if [ -f "$SCRIPTS_DIR/cloudflare/setup-tunnels.sh" ]; then
        log_info "Tri·ªÉn khai Cloudflare tunnel cho Mail Server..."
        
        # G·ªçi script setup tunnel v·ªõi c·∫•u h√¨nh mail
        "$SCRIPTS_DIR/cloudflare/setup-tunnels.sh" --service mail
        
        log_success "ƒê√£ tri·ªÉn khai Cloudflare tunnel cho Mail Server"
    else
        log_warning "Script Cloudflare tunnel kh√¥ng t√¨m th·∫•y, b·ªè qua b∆∞·ªõc n√†y"
    fi
}

# ============================================================================
# MAIN EXECUTION
# ============================================================================

# === DEPLOY FUNCTION (Chu·∫©n h√≥a theo docker-compose) ===
deploy_mail() {
    local force_deploy="${1:-false}"

    show_banner "üöÄ NEXTFLOW MAIL SERVER DEPLOYMENT"

    log_info "üöÄ B·∫Øt ƒë·∫ßu tri·ªÉn khai NextFlow Mail Server"
    echo

    # Ki·ªÉm tra y√™u c·∫ßu
    check_mail_requirements

    # Ki·ªÉm tra xung ƒë·ªôt port
    check_port_conflicts

    # T·∫°o th∆∞ m·ª•c
    create_mail_directories

    # Ki·ªÉm tra services c∆° b·∫£n
    check_basic_services

    # Thi·∫øt l·∫≠p database
    setup_mail_database

    # Deploy mail server qua docker-compose
    deploy_mail_via_compose "$force_deploy"

    # Ch·ªù s·∫µn s√†ng
    wait_for_mail_ready

    # Tri·ªÉn khai tunnel (t√πy ch·ªçn)
    deploy_mail_tunnel

    # Hi·ªÉn th·ªã th√¥ng tin
    show_mail_access_info

    log_success "‚úÖ Tri·ªÉn khai Mail Server ho√†n t·∫•t!"
    return 0
}

# === MAIN FUNCTION (Backward compatibility) ===
main() {
    deploy_mail "$@"
}

# Ch·∫°y script n·∫øu ƒë∆∞·ª£c g·ªçi tr·ª±c ti·∫øp
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi